{% extends "layout.html" %}

{% block title %}Gestión de Proveedores{% endblock %}

{% block content %}
<div class="container mt-3">
    <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
        <div class="position-sticky pt-3 mb-5">
            <a class="sidebar-img" href="{{ url_for('dashboard_admin') }}">
                <img src="{{ url_for('static', filename='img/Logo.png') }}" alt="Logo" width="100%">
            </a>
        </div>
        <div class="position-sticky">
            <ul class="nav flex-column">
                <li class="nav-item my-1">
                    <a class="nav-link active rounded-3" href="{{ url_for('dashboard_admin') }}">
                        Reportes
                    </a>
                </li>
                <li class="nav-item my-1">
                    <a class="nav-link rounded-3" href="{{ url_for('usuarios') }}">
                        Gestión de Usuarios
                    </a>
                </li>
                <li class="nav-item my-1">
                    <a class="nav-link rounded-3" href="{{ url_for('clientes') }}">
                        Gestión de Clientes 
                    </a>
                </li>
                <li class="nav-item my-1">
                    <a class="nav-link rounded-3" href="{{ url_for('proveedores') }}">
                        Gestión de Proveedores
                    </a>
                </li>
                <li class="nav-item my-1">
                    <a class="nav-link rounded-3" href="{{ url_for('recetas') }}">
                        Gestión de Recetas
                    </a>
                </li>
                <li class="nav-item mt-5">
                    <!-- Link de Cerrar Sesión con un ícono de Font Awesome -->
                    <a class="nav-link rounded-5 py-3" href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt"></i>  <!-- Ícono de Cerrar Sesión -->
                        Cerrar Sesión
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="text-dark mb-3 fw-normal fs-6">
        Home/Administrador/Gestionar Proveedores
    </div>

    <!-- Botón y búsqueda -->
    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProveedor" onclick="limpiarFormulario()">
            ➕ Nuevo proveedor
        </button>
        <input type="text" id="buscar" placeholder="Buscar" class="form-control" style="max-width: 200px;" onkeyup="filtrarProveedores()">
    </div>

    <!-- Tabla de proveedores -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Acción</th>
                <th>ID</th>
                <th>Empresa</th>
                <th>Teléfono</th>
                <th>Correo</th>
                <th>Dirección</th>
                <th>Productos</th>
            </tr>
        </thead>
        <tbody id="tablaProveedores">
            {% for proveedor in proveedores %}
            <tr id="row-{{ proveedor.id }}">
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editarProveedor('{{ proveedor.id }}')">✏️</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProveedor('{{ proveedor.id }}')">❌</button>
                </td>
                <td>{{ proveedor.id }}</td>
                <td>{{ proveedor.empresa }}</td>
                <td>{{ proveedor.telefono }}</td>
                <td>{{ proveedor.correo }}</td>
                <td>{{ proveedor.direccion }}</td>
                <td>{{ proveedor.productos }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="modalProveedor" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar/Editar Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formProveedor">
                    <input type="hidden" id="proveedorId">
                    <div class="mb-3">
                        <label>Empresa</label>
                        <input type="text" id="empresa" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Teléfono</label>
                        <input type="text" id="telefono" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Correo</label>
                        <input type="email" id="correo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Dirección</label>
                        <input type="text" id="direccion" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Productos</label>
                        <input type="text" id="productos" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="guardarProveedor()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function limpiarFormulario() {
    document.getElementById("formProveedor").reset();
    document.getElementById("proveedorId").value = "";
}

function guardarProveedor() {
    const id = document.getElementById('proveedorId').value;
    const data = {
        empresa: document.getElementById('empresa').value,
        telefono: document.getElementById('telefono').value,
        correo: document.getElementById('correo').value,
        direccion: document.getElementById('direccion').value,
        productos: document.getElementById('productos').value
    };

    let url = '/proveedores/agregar';
    let method = 'POST';

    if (id) {  // Si hay un ID, es una edición
        url = `/proveedores/editar/${id}`;
        method = 'POST';
    } else {
        data.id = new Date().getTime().toString(); // Generar un ID único si es nuevo
    }

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(res => {
        if (res.error) {
            alert("Error: " + res.error);
        } else {
            alert(res.mensaje);
            location.reload(); // Recargar la página para actualizar la tabla
        }
    })
    .catch(error => console.error('Error al guardar proveedor:', error));

    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalProveedor'));
    modal.hide();
}

function editarProveedor(id) {
    fetch(`/proveedores/${id}`)
        .then(response => response.json())
        .then(proveedor => {
            if (proveedor.error) {
                alert("Error: No se encontró el proveedor.");
                return;
            }

            // Rellenar los campos del modal
            document.getElementById("proveedorId").value = proveedor.id;
            document.getElementById("empresa").value = proveedor.empresa;
            document.getElementById("telefono").value = proveedor.telefono;
            document.getElementById("correo").value = proveedor.correo;
            document.getElementById("direccion").value = proveedor.direccion;
            document.getElementById("productos").value = proveedor.productos;

            // Abrir el modal
            new bootstrap.Modal(document.getElementById("modalProveedor")).show();
        })
        .catch(error => console.error("Error al obtener proveedor:", error));
}

function eliminarProveedor(id) {
    fetch(`/proveedores/eliminar/${id}`, { method: "DELETE" })
        .then(() => location.reload());
}

function filtrarProveedores() {
    const filtro = document.getElementById("buscar").value.toLowerCase();
    document.querySelectorAll("#tablaProveedores tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filtro) ? "" : "none";
    });
}
</script>

{% endblock %}