{% extends "ventas/base_ventas.html" %}

{% block content %}
<style>
    .seccion {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .seccion-compacta {
      width: 55%;
      border-radius: 10px;
      margin-bottom: 20px;
  }

  .seccion-compacta-total {
    width: 70%;
    border-radius: 10px;
    margin-bottom: 20px;
    margin-top: -220px;
    margin-left: 400px;
}
  

    .titulo {
        text-align: center;
        font-weight: bold;
        font-size: 40px;
        margin: 30px 0;
    }

    .input-sm {
        width: 100px;
    }

    .btn-checkmark {
        background-color: #8bc34a;
        border: none;
        padding: 10px 20px;
        color: white;
        font-weight: bold;
        border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
  }
  th {
      background-color: #f8b74a;
      padding: 10px;
      text-align: center;
      font-weight: bold;
  }
  td {
      background-color: #f9f9f9;
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
  }

    .btn-eliminar {
        background-color: #e74c3c;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        color: white;
    }

    .total-box {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
    }

    .btn-aceptar {
        background-color: #8bc34a;
        color: white;
        font-weight: bold;
        font-size: 20px;
        border: none;
        padding: 10px 30px;
        margin-top: 15px;
        border-radius: 5px;
    }
</style>

<h1 class="titulo">Generar venta</h1>

<div class="container">
    <!-- M√©todo de venta -->
    <div class="seccion seccion-compacta">
      <h5><strong>M√©todo de venta</strong></h5>
      <select class="form-select w-auto" id="metodoVentaSelect">
          <option selected>Por gramo</option>
          <option>Por unidad</option>
          <option>Empacado</option>
      </select>
  </div>   
    <!-- Detalle de venta -->
    <div class="seccion seccion-compacta">
        <h5><strong>Detalle de venta</strong></h5>
        <form class="row g-3 align-items-center" id="detalleVentaForm">
            <div class="col-auto">
                <label for="galleta" class="col-form-label">Galleta:</label>
                <select id="galleta" class="form-select">
                    <option selected disabled>Selecciona una galleta</option>
                </select>
            </div>
            <div class="col-auto" id="cantidadContainer">
                <label for="cantidad" class="col-form-label">Cantidad:</label>
                <select id="cantidad" class="form-select input-sm">
                    <option selected disabled>Selecciona cantidad</option>
                </select>
            </div>
            <div class="col-auto" id="gramosContainer">
                <label for="gramos" class="col-form-label">Gramos:</label>
                <input type="text" id="gramos" class="form-control input-sm" value="50gr">
            </div>
            <div class="col-auto">
                <label for="subtotal" class="col-form-label">Subtotal:</label>
                <input type="text" id="subtotal" class="form-control input-sm">
            </div>
            <div class="col-auto d-flex align-items-end">
                <button type="submit" class="btn btn-checkmark">‚úîÔ∏è</button>
            </div>
        </form>
    </div>

    <!-- Total -->
    <div class="row mb-4 seccion-compacta-total">
        <div class="col-md-6 offset-md-6">
            <div class="total-box">
                Total<br>$<span id="totalVenta">0.00</span>
                <br>
                <button class="btn-aceptar mt-3">‚úîÔ∏è Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Tabla de ventas -->
        <table>
            <thead>
                <tr>
                    <th>M√©todo de venta</th>
                    <th>Galleta</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaVentas">
            </tbody>
        </table>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const galletaSelect = document.getElementById('galleta');
        const cantidadSelect = document.getElementById('cantidad');
        const gramosInput = document.getElementById('gramos');
        const subtotalInput = document.getElementById('subtotal');
        const metodoVenta = document.getElementById('metodoVentaSelect');
        const cantidadContainer = document.getElementById('cantidadContainer');
        const gramosContainer = document.getElementById('gramosContainer');
        const totalVentaSpan = document.getElementById('totalVenta');
        const tablaVentas = document.getElementById('tablaVentas');
        const detalleVentaForm = document.getElementById('detalleVentaForm');
        
        // Variable para almacenar datos de la galleta actual seleccionada
        let galletaActual = null;
        let detallesVenta = []; // Almacena los items agregados a la venta
        let totalVenta = 0; // Almacena el total de la venta

        // Funci√≥n para actualizar la visibilidad de campos seg√∫n el m√©todo de venta
        function actualizarCamposVisibles() {
            const metodo = metodoVenta.value;
            
            if (metodo === 'Por gramo') {
                cantidadContainer.style.display = 'none';
                gramosContainer.style.display = 'block';
            } else if (metodo === 'Por unidad' || metodo === 'Empacado') {
                cantidadContainer.style.display = 'block';
                gramosContainer.style.display = 'none';
            }
        }
        
        // Funci√≥n para calcular el subtotal
        function calcularSubtotal() {
            const metodo = metodoVenta.value;
            
            if (metodo === 'Por unidad' && galletaActual && cantidadSelect.value) {
                // Obtener cantidad seleccionada (como n√∫mero)
                const cantidad = parseInt(cantidadSelect.value, 10);
                
                // Multiplicar precio unitario por cantidad
                const precioUnitario = parseFloat(galletaActual.precioUnitario);
                const subtotal = precioUnitario * cantidad;
                
                // Mostrar el subtotal formateado
                subtotalInput.value = '$' + subtotal.toFixed(2);
                return subtotal;
            }
            else if (metodo === 'Por gramo' && galletaActual && gramosInput.value) {
                // Extraer valor num√©rico de la entrada de gramos
                const gramos = parseInt(gramosInput.value, 10);
                
                if (!isNaN(gramos)) {
                    // Calcular el precio por los gramos
                    // Asumimos que precioUnitario es por gramo, o calculamos en base al gramaje
                    const precioUnitario = parseFloat(galletaActual.precioUnitario);
                    const gramajePorUnidad = parseFloat(galletaActual.gramajeGalleta);
                    const precioPorGramo = precioUnitario / gramajePorUnidad;
                    const subtotal = precioPorGramo * gramos;
                    
                    // Mostrar el subtotal formateado
                    subtotalInput.value = '$' + subtotal.toFixed(2);
                    return subtotal;
                }
            }
            else if (metodo === 'Empacado' && galletaActual && cantidadSelect.value) {
                // Obtener el tipo de caja seleccionada
                const tipoCaja = cantidadSelect.value;
                
                // Definir precios seg√∫n el tipo de caja
                let subtotal = 0;
                const precioUnitario = parseFloat(galletaActual.precioUnitario);
                
                if (tipoCaja === 'Caja 700gr') {
                    // Calculamos el precio de la caja basado en el precio unitario
                    subtotal = precioUnitario * 7; // Asumimos que la caja contiene aprox. 7 unidades
                } else if (tipoCaja === 'Caja 1kg') {
                    subtotal = precioUnitario * 10; // Asumimos que la caja contiene aprox. 10 unidades
                }
                
                // Mostrar el subtotal formateado
                subtotalInput.value = '$' + subtotal.toFixed(2);
                return subtotal;
            }
            
            // Si no se puede calcular, limpiar el campo
            subtotalInput.value = '';
            return 0;
        }
        
        // Funci√≥n para agregar un item a la tabla de ventas
        function agregarItemVenta(event) {
            event.preventDefault();
            
            if (!galletaActual) {
                alert('Por favor, selecciona una galleta.');
                return;
            }
            
            const metodo = metodoVenta.value;
            let cantidad, subtotal;
            
            if (metodo === 'Por gramo') {
                cantidad = gramosInput.value + 'gr';
                subtotal = calcularSubtotal();
                if (subtotal === 0) {
                    alert('Por favor, ingresa una cantidad v√°lida en gramos.');
                    return;
                }
            } else if (metodo === 'Por unidad' || metodo === 'Empacado') {
                if (!cantidadSelect.value || cantidadSelect.value === 'Selecciona cantidad') {
                    alert('Por favor, selecciona una cantidad.');
                    return;
                }
                cantidad = cantidadSelect.value;
                subtotal = calcularSubtotal();
            } else {
                alert('Por favor, selecciona un m√©todo de venta v√°lido.');
                return;
            }
            
            // Crear objeto para el detalle de venta
            const detalleVenta = {
                metodoVenta: metodo,
                idGalleta: galletaActual.idGalleta,
                nombreGalleta: galletaActual.nombreGalleta,
                cantidad: cantidad,
                subtotal: subtotal
            };
            
            // A√±adir a la lista de detalles
            detallesVenta.push(detalleVenta);
            
            // Actualizar la tabla
            actualizarTablaVentas();
            
            // Actualizar el total
            actualizarTotalVenta();
            
            // Limpiar el formulario
            limpiarFormularioDetalle();
        }
        
        // Funci√≥n para actualizar la tabla de ventas
        function actualizarTablaVentas() {
            tablaVentas.innerHTML = '';
            
            detallesVenta.forEach((detalle, index) => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${detalle.metodoVenta}</td>
                    <td>${detalle.nombreGalleta}</td>
                    <td>${detalle.cantidad}</td>
                    <td>$${detalle.subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn-eliminar" data-index="${index}">üóëÔ∏è</button>
                    </td>
                `;
                tablaVentas.appendChild(fila);
            });
            
            // Agregar listeners para los botones de eliminar
            document.querySelectorAll('.btn-eliminar').forEach(boton => {
                boton.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'), 10);
                    eliminarItemVenta(index);
                });
            });
        }
        
        // Funci√≥n para eliminar un item de la venta
        function eliminarItemVenta(index) {
            detallesVenta.splice(index, 1);
            actualizarTablaVentas();
            actualizarTotalVenta();
        }
        
        // Funci√≥n para actualizar el total de la venta
        function actualizarTotalVenta() {
            totalVenta = detallesVenta.reduce((total, item) => total + item.subtotal, 0);
            totalVentaSpan.textContent = totalVenta.toFixed(2);
        }
        
        // Funci√≥n para limpiar el formulario de detalle
        function limpiarFormularioDetalle() {
            galletaSelect.selectedIndex = 0;
            cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
            gramosInput.value = '50';
            subtotalInput.value = '';
            galletaActual = null;
        }

        // Ejecutar al cargar la p√°gina
        actualizarCamposVisibles();

        // Cargar galletas al iniciar
        fetch('/ventas/galletas_disponibles')
            .then(response => response.json())
            .then(data => {
                data.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.textContent = g.nombre;
                    galletaSelect.appendChild(option);
                });
            });

        // Escuchar cambio de galleta para actualizar cantidad y datos
        galletaSelect.addEventListener('change', () => {
            const idGalleta = galletaSelect.value;
            const metodo = metodoVenta.value;

            // Limpiar subtotal cuando cambia la galleta
            subtotalInput.value = '';

            // Obtener datos de la galleta seleccionada
            if (idGalleta) {
                fetch(`/ventas/galleta/${idGalleta}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // Guardar datos de la galleta actual
                            galletaActual = {
                                idGalleta: idGalleta,
                                nombreGalleta: galletaSelect.options[galletaSelect.selectedIndex].text,
                                cantidadDisponible: data.cantidadDisponible,
                                gramajeGalleta: data.gramaje,  // Cambio aqu√≠
                                precioUnitario: data.precio    // Cambio aqu√≠
                            };
                            
                            // Si la venta es por unidad, actualizar opciones de cantidad
                            if (metodo === 'Por unidad') {
                                const max = Math.min(data.cantidadDisponible, 20); // Limitamos a 20 o la cantidad disponible
                                cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
                                for (let i = 1; i <= max; i++) {
                                    const opt = document.createElement('option');
                                    opt.value = i;
                                    opt.textContent = i;
                                    cantidadSelect.appendChild(opt);
                                }
                            }
                        }
                    });
            }
        });

        // Escuchar cambio de cantidad para actualizar subtotal
        cantidadSelect.addEventListener('change', calcularSubtotal);
        
        // Escuchar cambio de gramos para actualizar subtotal
        gramosInput.addEventListener('input', calcularSubtotal);

        // Escuchar cambio de m√©todo de venta
        metodoVenta.addEventListener('change', () => {
            const metodo = metodoVenta.value;
            cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
            
            // Limpiar subtotal cuando cambia el m√©todo
            subtotalInput.value = '';

            // Actualizar visibilidad de campos
            actualizarCamposVisibles();

            if (metodo === 'Por unidad') {
                // Si ya hay una galleta seleccionada, cargar las cantidades
                if (galletaActual) {
                    const max = Math.min(galletaActual.cantidadDisponible, 20);
                    for (let i = 1; i <= max; i++) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = i;
                        cantidadSelect.appendChild(opt);
                    }
                }
            } else if (metodo === 'Por gramo') {
                gramosInput.value = '50';
                if (galletaActual) {
                    calcularSubtotal();
                }
            } else if (metodo === 'Empacado') {
                ['Caja 700gr', 'Caja 1kg'].forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    cantidadSelect.appendChild(option);
                });
            }
        });
        
        // Manejar el env√≠o del formulario de detalle
        detalleVentaForm.addEventListener('submit', agregarItemVenta);
    });
</script>    
{% endblock %}