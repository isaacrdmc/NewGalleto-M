{% extends "ventas/base_ventas.html" %}

{% block content %}
<style>
    .seccion {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .seccion-compacta {
      width: 55%;
      border-radius: 10px;
      margin-bottom: 20px;
  }

  .seccion-compacta-total {
    width: 70%;
    border-radius: 10px;
    margin-bottom: 20px;
    margin-top: -220px;
    margin-left: 400px;
}
  

    .titulo {
        text-align: center;
        font-weight: bold;
        font-size: 40px;
        margin: 30px 0;
    }

    .input-sm {
        width: 100px;
    }

    .btn-checkmark {
        background-color: #8bc34a;
        border: none;
        padding: 10px 20px;
        color: white;
        font-weight: bold;
        border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
  }
  th {
      background-color: #f8b74a;
      padding: 10px;
      text-align: center;
      font-weight: bold;
  }
  td {
      background-color: #f9f9f9;
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
  }

    .btn-eliminar {
        background-color: #e74c3c;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        color: white;
    }

    .total-box {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
    }

    .btn-aceptar {
        background-color: #8bc34a;
        color: white;
        font-weight: bold;
        font-size: 20px;
        border: none;
        padding: 10px 30px;
        margin-top: 15px;
        border-radius: 5px;
    }
</style>

<h1 class="titulo">Generar venta</h1>

<div class="container">
    <!-- M√©todo de venta -->
    <div class="seccion seccion-compacta">
      <h5><strong>M√©todo de venta</strong></h5>
      <select class="form-select w-auto" id="metodoVentaSelect">
          <option selected>Por gramo</option>
          <option>Por unidad</option>
          <option>Empacado</option>
      </select>
  </div>   
    <!-- Detalle de venta -->
    <div class="seccion seccion-compacta">
        <h5><strong>Detalle de venta</strong></h5>
        <form class="row g-3 align-items-center" id="detalleVentaForm">
            <div class="col-auto">
                <label for="galleta" class="col-form-label">Galleta:</label>
                <select id="galleta" class="form-select">
                    <option selected disabled>Selecciona una galleta</option>
                </select>
            </div>
            <div class="col-auto" id="cantidadContainer">
                <label for="cantidad" class="col-form-label">Cantidad:</label>
                <select id="cantidad" class="form-select input-sm">
                    <option selected disabled>Selecciona cantidad</option>
                </select>
            </div>
            <div class="col-auto" id="gramosContainer">
                <label for="gramos" class="col-form-label">Gramos:</label>
                <input type="text" id="gramos" class="form-control input-sm" placeholder="Ingrese gramos">
            </div>
            <div class="col-auto">
                <label for="subtotal" class="col-form-label">Subtotal:</label>
                <input type="text" id="subtotal" class="form-control input-sm" readonly>
            </div>
            <div class="col-auto d-flex align-items-end">
                <button type="submit" class="btn btn-checkmark">‚úîÔ∏è</button>
            </div>
        </form>
    </div>

    <!-- Total -->
    <div class="row mb-4 seccion-compacta-total">
        <div class="col-md-6 offset-md-6">
            <div class="total-box">
                Total<br>$<span id="totalVenta">0.00</span>
                <br>
                <button class="btn-aceptar mt-3">‚úîÔ∏è Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Tabla de ventas -->
        <table>
            <thead>
                <tr>
                    <th>M√©todo de venta</th>
                    <th>Galleta</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaVentas">
            </tbody>
        </table>
</div>
<!-- Fondo oscuro detr√°s del modal -->
<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:999;" onclick="cerrarModal()"></div>

<!-- Modal reutilizable para mensajes -->
<div id="modal-generico" style="display:none; position:fixed; top:25%; left:50%; transform:translate(-50%, 0); background:#f0d6b3; padding:0; border:none; z-index:1000; width:80%; max-width:600px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
    <div style="background-color:#0f1722; color:white; padding:20px; text-align:center;">
        <h2 style="margin:0; font-size:30px; font-weight:bold;">Aviso</h2>
    </div>
    <div style="padding:30px; text-align:center; font-size:20px; font-weight:500;" id="modal-mensaje">
        <!-- mensaje din√°mico -->
    </div>
    <div style="text-align:center; padding-bottom:25px;">
        <button onclick="cerrarModal()" style="background-color:#8bc34a; color:white; border:none; padding:12px 30px; font-size:16px; font-weight:bold; cursor:pointer; border-radius:5px;">Cerrar</button>
    </div>
</div>
<!-- MODAL TICKET -->
<div id="ticket-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000000aa; z-index:999;"></div>

<div id="ticket-modal" style="display:none; position:fixed; top:10%; left:50%; transform:translate(-50%, 0); background:#d4b186; width:90%; max-width:480px; padding:20px; border-radius:12px; z-index:1000; box-shadow:0 0 10px rgba(0,0,0,0.4); font-family:'Comic Sans MS', cursive, sans-serif; text-align:center;">
    <div style="background-color:#0f1722; color:white; padding:12px 0; border-radius:10px 10px 0 0;">
        <h2 style="margin:0; font-size:28px; font-weight:bold;">Don Galleto</h2>
    </div>
    <h3 style="margin:16px 0; font-weight:bold;">TICKET</h3>
    <p style="font-size:18px;">******************************</p>

    <div style="text-align:left; font-weight:bold; font-size:18px; margin-bottom:10px;">Detalles de venta:</div>

    <div id="ticket-detalles" style="font-size:16px; text-align:left; margin-bottom:15px;">
        <!-- Rellenado con JS -->
    </div>

    <p style="font-size:18px;">******************************</p>

    <div style="font-size:22px; font-weight:bold; margin:10px 0;">Total: $<span id="ticket-total"></span></div>

    <div style="display:flex; justify-content:space-between; gap:10px; margin-top:20px;">
        <button onclick="cerrarTicket()" style="flex:1; background-color:#d73e48; color:white; border:none; padding:12px 0; font-size:16px; font-weight:bold; border-radius:8px;">Cerrar</button>
        <button onclick="imprimirTicket()" style="flex:1; background-color:#f8b74a; color:white; border:none; padding:12px 0; font-size:16px; font-weight:bold; border-radius:8px;">Imprimir</button>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const galletaSelect = document.getElementById('galleta');
        const cantidadSelect = document.getElementById('cantidad');
        const gramosInput = document.getElementById('gramos');
        const subtotalInput = document.getElementById('subtotal');
        const metodoVenta = document.getElementById('metodoVentaSelect');
        const cantidadContainer = document.getElementById('cantidadContainer');
        const gramosContainer = document.getElementById('gramosContainer');
        const totalVentaSpan = document.getElementById('totalVenta');
        const tablaVentas = document.getElementById('tablaVentas');
        const detalleVentaForm = document.getElementById('detalleVentaForm');
        
        // Variable para almacenar datos de la galleta actual seleccionada
        let galletaActual = null;
        let detallesVenta = []; // Almacena los items agregados a la venta
        let totalVenta = 0; // Almacena el total de la venta

        let inventarioTemporal = {};

        // Funci√≥n para actualizar la visibilidad de campos seg√∫n el m√©todo de venta
        function actualizarCamposVisibles() {
            const metodo = metodoVenta.value;
            
            if (metodo === 'Por gramo') {
                cantidadContainer.style.display = 'none';
                gramosContainer.style.display = 'block';
            } else if (metodo === 'Por unidad' || metodo === 'Empacado') {
                cantidadContainer.style.display = 'block';
                gramosContainer.style.display = 'none';
            }
        }
        
        // Funci√≥n para calcular el subtotal
        function calcularSubtotal() {
            const metodo = metodoVenta.value;
            
            if (metodo === 'Por unidad' && galletaActual && cantidadSelect.value) {
                const cantidad = parseInt(cantidadSelect.value, 10);
                const precioUnitario = parseFloat(galletaActual.precioUnitario);
                const subtotal = precioUnitario * cantidad;
                subtotalInput.value = '$' + subtotal.toFixed(2);
                return subtotal;
            }
            else if (metodo === 'Empacado' && galletaActual && cantidadSelect.value) {
                const seleccion = cantidadSelect.value;
                const [cantidadCajas, tipo] = seleccion.split(' Caja ');
                const precioUnitario = parseFloat(galletaActual.precioUnitario);
                
                // Obtener las unidades por caja que calculamos antes
                const unidadesPorCaja = tipo === '700gr' ? 
                    galletaActual.unidadesPorCaja['700gr'] : 
                    galletaActual.unidadesPorCaja['1kg'];
                
                // Calcular subtotal correctamente
                const subtotal = (precioUnitario * unidadesPorCaja) * parseInt(cantidadCajas);
                
                subtotalInput.value = '$' + subtotal.toFixed(2);
                return subtotal;
            }
            
            subtotalInput.value = '';
            return 0;
        }

        // Agrega esta funci√≥n auxiliar en tu script:
        function redondearAGalletasCompletas(gramos, gramajePorUnidad) {
            if (gramajePorUnidad <= 0) return gramos;
            const galletasDecimales = gramos / gramajePorUnidad;
            const galletasCompletas = Math.floor(galletasDecimales);
            return galletasCompletas * gramajePorUnidad;
        }
        
        // Funci√≥n para agregar un item a la tabla de ventas
        function agregarItemVenta(event) {
            event.preventDefault();
            
            if (!galletaActual) {
                mostrarModal('Por favor, selecciona una galleta.');
                return;
            }

            if (inventarioTemporal[galletaActual.idGalleta] <= 0) {
                mostrarModal('No hay suficiente inventario disponible para esta galleta.');
                return;
            }            
            
            const metodoSeleccionado = metodoVenta.value;
            const precioUnitario = parseFloat(galletaActual.precioUnitario);
            const gramajePorUnidad = parseFloat(galletaActual.gramajeGalleta);
            
            if (metodoSeleccionado === 'Por gramo') {
                const gramos = parseInt(gramosInput.value, 10) || 0;
                if (gramos <= 0) {
                    mostrarModal('Por favor, ingresa una cantidad v√°lida en gramos.');
                    return;
                }

                // Calcular gramos v√°lidos (solo galletas completas)
                const gramosAjustados = redondearAGalletasCompletas(gramos, gramajePorUnidad);

                // Calcular cajas posibles (AGREGAR ESTAS 2 L√çNEAS)
                const unidadesPorCaja700 = Math.floor(700 / gramajePorUnidad);
                const unidadesPorCaja1kg = Math.floor(1000 / gramajePorUnidad);
                let cajas1kg = 0, cajas700 = 0, gramosSueltos = gramosAjustados;

                // Calcular cajas de 1kg
                if (unidadesPorCaja1kg > 0) {
                    cajas1kg = Math.floor(gramosSueltos / 1000);
                    gramosSueltos = gramosSueltos % 1000;
                }

                // Calcular cajas de 700gr con lo que sobra
                if (unidadesPorCaja700 > 0) {
                    cajas700 = Math.floor(gramosSueltos / 700);
                    gramosSueltos = gramosSueltos % 700;
                }

                // Validar gramos sobrantes finales
                const galletasSueltas = gramosSueltos / gramajePorUnidad;
                if (galletasSueltas > 0 && galletasSueltas < 1) {
                    // Descartar gramos insuficientes
                    gramosSueltos = 0;
                }

                // Despu√©s de calcular los gramosSueltos
                if (gramosSueltos > 0 && (gramosSueltos % gramajePorUnidad !== 0)) {
                    const descartados = gramosSueltos % gramajePorUnidad;
                    gramosSueltos = gramosSueltos - descartados;
                    if (gramosSueltos > 0) {
                        mostrarModal(`Se descartaron ${descartados}gr que no completaban una galleta.`);
                    }
                }

                if (gramosAjustados <= 0) {
                    mostrarModal('Los gramos ingresados no alcanzan para una galleta completa.');
                    return;
                }

                const unidadesEquivalentes = gramosAjustados / gramajePorUnidad;

                if (unidadesEquivalentes > inventarioTemporal[galletaActual.idGalleta]) {
                    mostrarModal('No hay suficiente inventario disponible para esta cantidad.');
                    return;
                }
                
                // Agregar items por separado
                if (cajas1kg > 0) {
                    const detalle = {
                        metodoVenta: 'Empacado',
                        idGalleta: galletaActual.idGalleta,
                        nombreGalleta: galletaActual.nombreGalleta,
                        cantidad: `${cajas1kg} Caja${cajas1kg > 1 ? 's' : ''} 1kg`,
                        subtotal: (precioUnitario * unidadesPorCaja1kg) * cajas1kg,
                        gramajeGalleta: gramajePorUnidad,
                        unidadesPorCaja: galletaActual.unidadesPorCaja                    
                    };
                    detallesVenta.push(detalle);
                }
                
                if (cajas700 > 0) {
                    const detalle = {
                        metodoVenta: 'Empacado',
                        idGalleta: galletaActual.idGalleta,
                        nombreGalleta: galletaActual.nombreGalleta,
                        cantidad: `${cajas700} Caja${cajas700 > 1 ? 's' : ''} 700gr`,
                        subtotal: (precioUnitario * unidadesPorCaja700) * cajas700,
                        gramajeGalleta: gramajePorUnidad,
                        unidadesPorCaja: galletaActual.unidadesPorCaja                    
                    };
                    detallesVenta.push(detalle);
                }
                
                if (gramosSueltos > 0) {
                    const detalle = {
                        metodoVenta: 'Por gramo',
                        idGalleta: galletaActual.idGalleta,
                        nombreGalleta: galletaActual.nombreGalleta,
                        cantidad: `${gramosSueltos}gr`,
                        subtotal: (precioUnitario / gramajePorUnidad) * gramosSueltos,
                        gramajeGalleta: gramajePorUnidad,
                        unidadesPorCaja: galletaActual.unidadesPorCaja                    
                    };
                    detallesVenta.push(detalle);
                }

                // Sumar unidades de todos los subdetalles agregados
                let totalUnidadesUsadas = 0;
                if (cajas1kg > 0) totalUnidadesUsadas += cajas1kg * unidadesPorCaja1kg;
                if (cajas700 > 0) totalUnidadesUsadas += cajas700 * unidadesPorCaja700;
                if (gramosSueltos > 0) totalUnidadesUsadas += Math.floor(gramosSueltos / gramajePorUnidad);

                inventarioTemporal[galletaActual.idGalleta] -= totalUnidadesUsadas;

                
            } 
            else if (metodoSeleccionado === 'Por unidad') {
                if (!cantidadSelect.value || cantidadSelect.value === 'Selecciona cantidad') {
                    mostrarModal('Por favor, selecciona una cantidad.');
                    return;
                }
                
                const unidades = parseInt(cantidadSelect.value, 10);
                const unidadesPorCaja700 = Math.floor(700 / gramajePorUnidad);
                const unidadesPorCaja1kg = Math.floor(1000 / gramajePorUnidad);
                
                let cajas1kg = 0, cajas700 = 0, unidadesSueltas = unidades;
            
                let totalUnidadesUsadas = unidades; // üí• A√ëADIR ESTO
                
                // Calcular cajas de 1kg
                if (unidadesPorCaja1kg > 0) {
                    cajas1kg = Math.floor(unidades / unidadesPorCaja1kg);
                    unidadesSueltas = unidades % unidadesPorCaja1kg;
                }
                
                // Calcular cajas de 700gr
                if (unidadesPorCaja700 > 0) {
                    cajas700 = Math.floor(unidadesSueltas / unidadesPorCaja700);
                    unidadesSueltas = unidadesSueltas % unidadesPorCaja700;
                }
                
                // Agregar items por separado
                if (cajas1kg > 0) {
                    const detalle = {
                        metodoVenta: 'Empacado',
                        idGalleta: galletaActual.idGalleta,
                        nombreGalleta: galletaActual.nombreGalleta,
                        cantidad: `${cajas1kg} Caja${cajas1kg > 1 ? 's' : ''} 1kg`,
                        subtotal: (precioUnitario * unidadesPorCaja1kg) * cajas1kg,
                        gramajeGalleta: gramajePorUnidad,
                        unidadesPorCaja: galletaActual.unidadesPorCaja                    
                    };
                    detallesVenta.push(detalle);
                }
                
                if (cajas700 > 0) {
                    const detalle = {
                        metodoVenta: 'Empacado',
                        idGalleta: galletaActual.idGalleta,
                        nombreGalleta: galletaActual.nombreGalleta,
                        cantidad: `${cajas700} Caja${cajas700 > 1 ? 's' : ''} 700gr`,
                        subtotal: (precioUnitario * unidadesPorCaja700) * cajas700,
                        gramajeGalleta: gramajePorUnidad,
                        unidadesPorCaja: galletaActual.unidadesPorCaja                    
                    };
                    detallesVenta.push(detalle);
                }
                
                if (unidadesSueltas > 0) {
                    const detalle = {
                        metodoVenta: 'Por unidad',
                        idGalleta: galletaActual.idGalleta,
                        nombreGalleta: galletaActual.nombreGalleta,
                        cantidad: `${unidadesSueltas} unidad${unidadesSueltas > 1 ? 'es' : ''}`,
                        subtotal: precioUnitario * unidadesSueltas,
                        gramajeGalleta: gramajePorUnidad,
                        unidadesPorCaja: galletaActual.unidadesPorCaja
                    };
                    detallesVenta.push(detalle);
                }
            
                inventarioTemporal[galletaActual.idGalleta] -= totalUnidadesUsadas;
            }            
            else if (metodoSeleccionado === 'Empacado') {
                // Mantener l√≥gica original para empacado
                if (!cantidadSelect.value || cantidadSelect.value === 'Selecciona empaque') {
                    mostrarModal('Por favor, selecciona un empaque.');
                    return;
                }
                
                const [cantidadCajas, tipo] = cantidadSelect.value.split(' Caja ');
                const unidadesPorCaja = tipo === '700gr' ? 
                    galletaActual.unidadesPorCaja['700gr'] : 
                    galletaActual.unidadesPorCaja['1kg'];
                
                const detalle = {
                    metodoVenta: 'Empacado',
                    idGalleta: galletaActual.idGalleta,
                    nombreGalleta: galletaActual.nombreGalleta,
                    cantidad: cantidadSelect.value,
                    subtotal: (precioUnitario * unidadesPorCaja) * parseInt(cantidadCajas)
                };
                detallesVenta.push(detalle);
                inventarioTemporal[galletaActual.idGalleta] -= parseInt(cantidadCajas) * unidadesPorCaja;
            }
            
            // Actualizar la tabla y total
            actualizarTablaVentas();
            actualizarTotalVenta();
            limpiarFormularioDetalle();
        }

        gramosInput.addEventListener('input', function(e) {
            // Solo permite n√∫meros
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Limitar a un m√°ximo razonable (ej. 5000 gramos = 5kg)
            if (parseInt(this.value) > 5000) {
                this.value = '5000';
            }
        });

        function actualizarOpcionesCantidadSegunMetodo() {
            const metodo = metodoVenta.value;
        
            if (!galletaActual) return;
        
            const id = galletaActual.idGalleta;
        
            if (metodo === 'Por unidad') {
                cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
                for (let i = 1; i <= inventarioTemporal[id]; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    cantidadSelect.appendChild(opt);
                }
            } else if (metodo === 'Empacado') {
                calcularOpcionesEmpacado(inventarioTemporal[id], galletaActual.gramajeGalleta);
            }
        }
        

        // Funci√≥n para eliminar un item de la venta
        function eliminarItemVenta(index) {
            const item = detallesVenta[index];
            detallesVenta.splice(index, 1);
            const id = item.idGalleta;
        
            // Extraer cantidad de unidades desde el texto del item
            let unidadesADevolver = 0;
        
            if (item.metodoVenta === 'Por unidad') {
                const match = item.cantidad.match(/(\d+)/);
                unidadesADevolver = parseInt(match[1], 10);
            } else if (item.metodoVenta === 'Empacado') {
                const match = item.cantidad.match(/(\d+)\s+Caja\s+(700gr|1kg)/);
                if (match) {
                    const cajas = parseInt(match[1], 10);
                    const tipo = match[2];
                    const unidadesPorCaja = item.unidadesPorCaja?.[tipo];
                    unidadesADevolver = cajas * unidadesPorCaja;
                }
            } else if (item.metodoVenta === 'Por gramo') {
                const match = item.cantidad.match(/(\d+)gr/);
                if (match) {
                    const gramos = parseInt(match[1], 10);
                    unidadesADevolver = Math.floor(gramos / item.gramajeGalleta);
                }
            }
        
            // Surtir inventario
            inventarioTemporal[id] += unidadesADevolver;
        
            actualizarTablaVentas();
            actualizarTotalVenta();
        
            if (galletaActual && galletaActual.idGalleta === id) {
                actualizarOpcionesCantidadSegunMetodo();
            }
            
        }
        
        // Funci√≥n para actualizar la tabla de ventas
        function actualizarTablaVentas() {
            tablaVentas.innerHTML = '';
            
            detallesVenta.forEach((detalle, index) => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${detalle.metodoVenta}</td>
                    <td>${detalle.nombreGalleta}</td>
                    <td>${detalle.cantidad}</td>
                    <td>$${detalle.subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn-eliminar" data-index="${index}">üóëÔ∏è</button>
                    </td>
                `;
                tablaVentas.appendChild(fila);
            });
            
            // Agregar listeners para los botones de eliminar
            document.querySelectorAll('.btn-eliminar').forEach(boton => {
                boton.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'), 10);
                    eliminarItemVenta(index);
                });
            });
        }
        
        // Funci√≥n para actualizar el total de la venta
        function actualizarTotalVenta() {
            totalVenta = detallesVenta.reduce((total, item) => total + item.subtotal, 0);
            totalVentaSpan.textContent = totalVenta.toFixed(2);
        }
        
        // Funci√≥n para limpiar el formulario de detalle
        function limpiarFormularioDetalle() {
            galletaSelect.selectedIndex = 0;
            cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
            gramosInput.value = '';
            subtotalInput.value = '';
            galletaActual = null;
        }

        // Ejecutar al cargar la p√°gina
        actualizarCamposVisibles();

        function calcularOpcionesEmpacado(cantidadDisponible, gramajePorUnidad) {
            // Limpiar select primero
            cantidadSelect.innerHTML = '<option selected disabled>Selecciona empaque</option>';
            
            // Validar que el gramaje sea v√°lido
            if (gramajePorUnidad <= 0) {
                const opt = document.createElement('option');
                opt.value = '0';
                opt.textContent = 'Gramaje no v√°lido';
                opt.disabled = true;
                cantidadSelect.appendChild(opt);
                return;
            }
        
            // Calcular unidades por tipo de caja
            const unidadesPorCaja700 = Math.floor(700 / gramajePorUnidad);
            const unidadesPorCaja1kg = Math.floor(1000 / gramajePorUnidad);
            
            // Guardar esta informaci√≥n para c√°lculos posteriores
            galletaActual.unidadesPorCaja = {
                '700gr': unidadesPorCaja700,
                '1kg': unidadesPorCaja1kg
            };
        
            // Calcular m√°ximas cajas posibles de cada tipo
            const maxCajas700 = unidadesPorCaja700 > 0 ? 
                Math.floor(cantidadDisponible / unidadesPorCaja700) : 0;
            const maxCajas1kg = unidadesPorCaja1kg > 0 ? 
                Math.floor(cantidadDisponible / unidadesPorCaja1kg) : 0;
        
            // Agregar opciones para cajas de 700gr
            if (unidadesPorCaja700 > 0) {
                for (let i = 1; i <= maxCajas700; i++) {
                    const totalUnidades = i * unidadesPorCaja700;
                    const opt = document.createElement('option');
                    opt.value = `${i} Caja 700gr`;
                    opt.textContent = `${i} Caja 700gr (${totalUnidades} unidades)`;
                    opt.dataset.unidades = totalUnidades;
                    cantidadSelect.appendChild(opt);
                }
            }
        
            // Agregar opciones para cajas de 1kg
            if (unidadesPorCaja1kg > 0) {
                for (let i = 1; i <= maxCajas1kg; i++) {
                    const totalUnidades = i * unidadesPorCaja1kg;
                    const opt = document.createElement('option');
                    opt.value = `${i} Caja 1kg`;
                    opt.textContent = `${i} Caja 1kg (${totalUnidades} unidades)`;
                    opt.dataset.unidades = totalUnidades;
                    cantidadSelect.appendChild(opt);
                }
            }
        
            // Mostrar mensaje si no hay opciones disponibles
            if (maxCajas700 === 0 && maxCajas1kg === 0) {
                const opt = document.createElement('option');
                opt.value = '0';
                opt.textContent = unidadesPorCaja700 === 0 && unidadesPorCaja1kg === 0 ?
                    'Las galletas son muy grandes para los empaques est√°ndar' :
                    'No hay suficientes unidades para empaquetar';
                opt.disabled = true;
                cantidadSelect.appendChild(opt);
            }
        
            // Si hay exactamente una opci√≥n, seleccionarla autom√°ticamente
            if ((maxCajas700 === 1 && maxCajas1kg === 0) || (maxCajas700 === 0 && maxCajas1kg === 1)) {
                cantidadSelect.selectedIndex = 1;
                calcularSubtotal(); // Calcular subtotal autom√°ticamente
            }
        }

        // Cargar galletas al iniciar
        fetch('/ventas/galletas_disponibles')
            .then(response => response.json())
            .then(data => {
                data.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.textContent = g.nombre;
                    galletaSelect.appendChild(option);
                });
            });

        // Escuchar cambio de galleta para actualizar cantidad y datos
        galletaSelect.addEventListener('change', () => {
            const idGalleta = galletaSelect.value;
            const metodo = metodoVenta.value;
        
            subtotalInput.value = '';
        
            if (idGalleta) {
                fetch(`/ventas/galleta/${idGalleta}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            galletaActual = {
                                idGalleta: idGalleta,
                                nombreGalleta: galletaSelect.options[galletaSelect.selectedIndex].text,
                                cantidadDisponible: data.cantidadDisponible,
                                gramajeGalleta: data.gramaje,
                                precioUnitario: data.precio
                            };

                             // NUEVO: Guarda en inventario temporal si no existe
                            if (inventarioTemporal[idGalleta] === undefined) {
                                inventarioTemporal[idGalleta] = data.cantidadDisponible;
                            }
        
                            if (metodo === 'Por unidad') {
                                const max = inventarioTemporal[galletaActual.idGalleta];
                                cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
                                for (let i = 1; i <= max; i++) {
                                    const opt = document.createElement('option');
                                    opt.value = i;
                                    opt.textContent = i;
                                    cantidadSelect.appendChild(opt);
                                }
                            } 
                            else if (metodo === 'Empacado') {
                                calcularOpcionesEmpacado(inventarioTemporal[idGalleta], data.gramaje);
                            }
                        }
                    });
            }
        });

        // Escuchar cambio de cantidad para actualizar subtotal
        cantidadSelect.addEventListener('change', calcularSubtotal);
        
        // Escuchar cambio de gramos para actualizar subtotal
        gramosInput.addEventListener('input', calcularSubtotal);

        // Escuchar cambio de m√©todo de venta
        metodoVenta.addEventListener('change', () => {
            const metodo = metodoVenta.value;
            cantidadSelect.innerHTML = '<option selected disabled>Selecciona cantidad</option>';
            subtotalInput.value = '';
            actualizarCamposVisibles();
        
            if (metodo === 'Por unidad' && galletaActual) {
                const max = inventarioTemporal[galletaActual.idGalleta];
                for (let i = 1; i <= max; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    cantidadSelect.appendChild(opt);
                }
            } 
            else if (metodo === 'Empacado' && galletaActual) {
                calcularOpcionesEmpacado(galletaActual.cantidadDisponible, galletaActual.gramajeGalleta);
            }
            else if (metodo === 'Empacado') {
                ['Caja 700gr', 'Caja 1kg'].forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    option.disabled = true;
                    cantidadSelect.appendChild(option);
                });
            }
        });
        // Manejar el env√≠o del formulario de detalle
        detalleVentaForm.addEventListener('submit', agregarItemVenta);

        const botonAceptar = document.querySelector('.btn-aceptar');

        botonAceptar.addEventListener('click', () => {
            if (detallesVenta.length === 0) {
                mostrarModal('Agrega al menos un detalle a la venta.');
                return;
            }

            fetch('/ventas/registrar_venta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    detalles: detallesVenta,
                    total: totalVenta
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarModal("‚úîÔ∏è Venta registrada exitosamente", true);
                } else {
                    mostrarModal('Error al registrar la venta: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                mostrarModal('Error al procesar la venta.');
            });
        });
        
        function mostrarModal(mensaje, reload = false) {
            document.getElementById('modal-mensaje').textContent = mensaje;
            document.getElementById('modal-generico').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        
            if (reload) {
                // Esperamos a que el usuario cierre para recargar
                cerrarModal = function() {
                    document.getElementById('modal-generico').style.display = 'none';
                    document.getElementById('modal-overlay').style.display = 'none';
                    location.reload();
                };
            } else {
                cerrarModal = function() {
                    document.getElementById('modal-generico').style.display = 'none';
                    document.getElementById('modal-overlay').style.display = 'none';
                };
            }
        }
        function mostrarTicket(detalles, total) {
            const modal = document.getElementById('ticket-modal');
            const overlay = document.getElementById('ticket-overlay');
            const contenedor = document.getElementById('ticket-detalles');
            const totalSpan = document.getElementById('ticket-total');
        
            contenedor.innerHTML = '';
        
            detalles.forEach((d, i) => {
                contenedor.innerHTML += `
                    <div style="margin-bottom:8px;">
                        <div style="font-weight:bold;">${d.nombreGalleta}</div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>${d.cantidad}</span>
                            <span>${d.metodoVenta}</span>
                            <span>$${d.subtotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
        
            totalSpan.textContent = total.toFixed(2);
        
            modal.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        function cerrarTicket() {
            document.getElementById('ticket-modal').style.display = 'none';
            document.getElementById('ticket-overlay').style.display = 'none';
        }
        
        function imprimirTicket() {
            const ticket = document.getElementById('ticket-modal').innerHTML;
        
            const ventana = window.open('', '', 'width=600,height=800');
            ventana.document.write(`
                <html>
                <head><title>Ticket Don Galleto</title></head>
                <body style="font-family:'Comic Sans MS', sans-serif;">${ticket}</body>
                </html>
            `);
            ventana.document.close();
            ventana.focus();
            ventana.print();
        }                      
    });
</script>    
{% endblock %}