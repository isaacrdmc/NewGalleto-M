{% extends "shared/base_admin.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3" style="padding-left: 250px;">
        <div class="text-white fw-normal fs-6">
            <h1>Dashboard del Administrador</h1>
        </div>

        <!-- Botón de notificaciones -->
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownNotificaciones"
                data-bs-toggle="dropdown" aria-expanded="false">
                <img src="{{ url_for('static', filename='img/notificacion.png') }}" alt="notificaciones" width="20">
                Notificaciones <span class="badge bg-danger" id="contadorNotificaciones">0</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownNotificaciones"
                id="listaNotificaciones">
                <li>
                    <div class="dropdown-item text-center">No hay notificaciones pendientes</div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Contenido del Dashboard -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-4 rounded-4">
        <!-- Fila de estadísticas -->
        <div class="row">
            <!-- Ventas Semanales -->
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Ventas Semanales</h5>
                        <h3 class="card-text text-success">${{ "%.2f"|format(ventas_semanales.get('total_ventas', 0)) }}
                        </h3>
                        <p class="text-muted">{{ ventas_semanales.get('cantidad_ventas', 0) }} transacciones</p>
                    </div>
                </div>
            </div>

            <!-- Productos Más Vendidos -->
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Galletas semanales mas vendidas (pzas)</h5>
                        <ol class="ps-3">
                            {% for galleta in top_galletas %}
                            <li>{{ galleta.get('nombre', 'N/A') }} <span class="text-success">(${{
                                    "%.2f"|format(galleta.get('total_ventas', 0)) }})</span></li>
                            {% else %}
                            <li>No hay datos disponibles</li>
                            {% endfor %}
                        </ol>
                        <p class="text-muted">Por ganancias totales</p>
                    </div>
                </div>
            </div>

            <!-- Presentaciones Más Vendidas -->
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Presentaciones semanales mas vendidas</h5>
                        <ol class="ps-3">
                            {% for presentacion in top_presentaciones %}
                            <li>
                                {% if presentacion.get('formaVenta') == 'Por pieza' %}
                                Por Pieza
                                {% elif presentacion.get('formaVenta') == 'Por precio' %}
                                Por Gramos
                                {% else %}
                                {{ presentacion.get('formaVenta', 'Paquete/Caja') }}
                                {% endif %}
                                <span class="text-success">(${{ "%.2f"|format(presentacion.get('total_ventas', 0))
                                    }})</span>
                            </li>
                            {% else %}
                            <li>No hay datos disponibles</li>
                            {% endfor %}
                        </ol>
                        <p class="text-muted">Por ganancias totales</p>
                    </div>
                </div>
            </div>

            <!-- Estimación de Costos -->
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Estimación Semanal</h5>
                        <p class="mb-1">Ventas: <span class="text-success">${{
                                "%.2f"|format(estimacion_costos.get('ventas', 0)) }}</span></p>
                        <p class="mb-1">Compras: <span class="text-danger">${{
                                "%.2f"|format(estimacion_costos.get('compras', 0)) }}</span></p>
                        <p class="mb-1">Mermas: <span class="text-warning">${{
                                "%.2f"|format(estimacion_costos.get('mermas', 0)) }}</span></p>
                        <hr>
                        <h6 class="mb-0">Ganancia:
                            <span
                                class="{% if estimacion_costos.get('ganancia', 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ "%.2f"|format(estimacion_costos.get('ganancia', 0)) }}
                            </span>
                        </h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos de rendimiento -->
        <div class="row">
            <!-- Gráfico de Ventas por Semana -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Ventas Últimas 4 Semanas</h5>
                        <canvas id="ventasSemanales"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Ventas por Día -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Ventas por Día (Última Semana)</h5>
                        <canvas id="ventasDiarias"></canvas>
                    </div>
                </div>
            </div>

            <!-- Después de las gráficas existentes -->
            <div class="row">
                <!-- Gráfico de Producción Semanal -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Producción Semanal</h5>
                            <canvas id="produccionSemanal"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Eficiencia de Producción -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Eficiencia por Tipo de Galleta</h5>
                            <canvas id="eficienciaProduccion"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Gráfico 1: Ventas semanales (barras)
        var ctxVentasSemanales = document.getElementById('ventasSemanales').getContext('2d');
        new Chart(ctxVentasSemanales, {
            type: 'bar',
            data: {
                labels: JSON.parse('{{ historial_ventas.semanas|tojson|safe }}'),
                datasets: [{
                    label: 'Ventas en $',
                    data: JSON.parse('{{ historial_ventas.datos|tojson|safe }}'),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Gráfico 2: Ventas diarias (línea)
        var ctxVentasDiarias = document.getElementById('ventasDiarias').getContext('2d');
        new Chart(ctxVentasDiarias, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ ventas_por_dia.fechas|tojson|safe }}'),
                datasets: [{
                    label: 'Ventas en $',
                    data: JSON.parse('{{ ventas_por_dia.datos|tojson|safe }}'),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Gráfico 3: Producción semanal (barras agrupadas)
        var ctxProduccion = document.getElementById('produccionSemanal').getContext('2d');
        new Chart(ctxProduccion, {
            type: 'bar',
            data: {
                labels: JSON.parse('{{ produccion_semanal.fechas|tojson|safe }}'),
                datasets: [
                    {
                        label: 'Galletas Producidas',
                        data: JSON.parse('{{ produccion_semanal.producido|tojson|safe }}'),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Merma Total',
                        data: JSON.parse('{{ produccion_semanal.merma|tojson|safe }}'),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfico 4: Eficiencia de producción (radar)
        var ctxEficiencia = document.getElementById('eficienciaProduccion').getContext('2d');
        new Chart(ctxEficiencia, {
            type: 'radar',
            data: {
                labels: JSON.parse('{{ eficiencia_produccion|map(attribute="galleta")|list|tojson|safe }}'),
                datasets: [{
                    label: 'Eficiencia (%)',
                    data: JSON.parse('{{ eficiencia_produccion|map(attribute="eficiencia")|list|tojson|safe }}'),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(75, 192, 192, 1)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    });

    // Función para cargar notificaciones
    async function cargarNotificaciones() {
        try {
            const response = await fetch('/admin/notificaciones');
            if (!response.ok) throw new Error('Error al cargar notificaciones');

            const notificaciones = await response.json();
            const lista = document.getElementById('listaNotificaciones');
            const contador = document.getElementById('contadorNotificaciones');

            lista.innerHTML = '';
            contador.textContent = notificaciones.length;

            if (notificaciones.length === 0) {
                lista.innerHTML = '<li><div class="dropdown-item text-muted">No hay notificaciones nuevas</div></li>';
                return;
            }

            notificaciones.forEach(notif => {
                const item = document.createElement('li');
                item.innerHTML = `
                <a class="dropdown-item" href="#">
                    <strong>${notif.tipo}</strong><br>
                    <small>${notif.mensaje}</small>
                    <div class="text-end"><small class="text-muted">${new Date(notif.fecha).toLocaleString()}</small></div>
                </a>
            `;
                lista.appendChild(item);
            });

            lista.innerHTML += `
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-center" href="#">Ver todas las notificaciones</a></li>
        `;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Cargar notificaciones al inicio y cada 30 segundos
    document.addEventListener('DOMContentLoaded', () => {
        cargarNotificaciones();
        setInterval(cargarNotificaciones, 30000);
    });
</script>

{% endblock %}