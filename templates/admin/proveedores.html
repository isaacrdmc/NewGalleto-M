{% extends "shared/base_admin.html" %}

{% block title %}Gestión de Proveedores{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="text-white mb-3 fw-normal fs-6" style="padding-left: 250px;">
        Home / Administrador / Gestionar Proveedores
    </div>
    <main class="col-md-9 ms-sm-auto col-lg-10 px-4 rounded-4">
        <div class="container mt-3">
            <!-- Botón y búsqueda -->
            <div class="d-flex justify-content-between mb-3">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalp"
                    onclick="limpiarFormulario()">
                    ➕ Nuevo proveedor
                </button>
                <input type="text" id="buscar" placeholder="Buscar" class="form-control" style="max-width: 200px;"
                    onkeyup="filtrarpes()">
            </div>

            <div class="table-responsive">
                <!-- Tabla de proveedores -->
                <table class="table table-bordered bg-white text-center">
                    <thead>
                        <tr>
                            <th>Acción</th>
                            <th>Empresa</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Dirección</th>
                            <th>Productos</th>
                        </tr>
                    </thead> 
                    <tbody id="tablapes">
                        {% for p in proveedor %}
                        <tr id="row-{{ p.idProveedores }}">
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editarp('{{ p.idProveedores }}')">✏️</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarp('{{ p.idProveedores }}')">❌</button>
                            </td>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.telefono }}</td>
                            <td>{{ p.correo }}</td>
                            <td>{{ p.direccion }}</td>
                            <td>{{ p.productosProveedor }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
        </div>

        <!-- ^ Modal para agregar/editar proveedores -->
        <div class="modal fade" id="modalp" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar/Editar proveedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <form method="post" action="{{ url_for('admin.proveedores') }}" id="formp">
                            {{ form.hidden_tag() }}
                            <!-- <input type="hidden" name="pId"> -->
                            <div class="mb-3">
                                {{ form.empresa.label(class="form-label") }}
                                {{ form.empresa(class="form-control", id="empresa", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.telefono.label(class="form-label") }}
                                {{ form.telefono(class="form-control", id="telefono", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.correo.label(class="form-label") }}
                                {{ form.correo(class="form-control", id="correo", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.direccion.label(class="form-label") }}
                                {{ form.direccion(class="form-control", id="direccion", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.productos.label(class="form-label") }}
                                {{ form.productos(class="form-control", id="productos", required="required") }}
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="guardarp()">Guardar</button>
                    </div>

                </div>
            </div>
        </div>




    </main>
</div>

<!-- JavaScript -->
<script>
    function limpiarFormulario() {
        document.getElementById("formp").reset();
        // const pIdElement = document.getElementById("pId");
        /*
        if (pIdElement) {
            pIdElement.value = "";
        }
        */
    }
    // ! Error de consola


    <!-- ? Función para guardar los datos dentro de la BD -->
    async function guardarp() {
        try {
            const data = {
                empresa: document.getElementById('empresa').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                correo: document.getElementById('correo').value.trim(),
                direccion: document.getElementById('direccion').value.trim(),
                productos: document.getElementById('productos').value.trim()
            };

            // Validamos los campos básicos
            if (!data.empresa || !data.telefono || !data.correo) {
                throw new Error('Por favor completa TODOS los campos requeridos');
            };

            
            // Ruta para agregar proveedores
            const url = '/admin/proveedores/agregar';
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name="csrf_token"]')?.value || ''
                },
                body: JSON.stringify(data)
            });

            // Verificamos si la respuesta es exitosa
            let result;
            if (response.ok) {
                result = await response.json();
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
            }

            // <!-- ! Error de consola -->
            // Mostramos un mensaje de éxito
            mostrarNotificacion(result.mensaje, 'success');

            // Cerramos el modal y limpiamos el formulario
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalp'));
            if (modal) modal.hide();
            limpiarFormulario();
            actualizarTablaProveedores();
        } catch (error) {
            console.error('Error:', error);
            mostrarNotificacion(error.message || 'Error desconocido', 'error');
        }
    };

    // <!-- ? Función par amostrar las notificaciónes: -->
    function mostrarNotificacion(mensaje, tipo='success'){
        // <!-- TODO es para implementarlo con 'SweetAlert' u otros -->
        alert(`${tipo.toUpperCase()}: ${mensaje}`);
    };

    // <!-- ? Función para actualizar la tabla sin necesidad de recargar la página -->
    async function actualizarTablaProveedores() {
        try {
            
            const response = await fetch('/admin/proveedores/listar');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
            }

            const proveedores = await response.json();

            // Actualizar la tabla con los datos obtenidos
            const tbody = document.querySelector('#tablapes');
            tbody.innerHTML = ''; // Limpiar la tabla

            proveedores.forEach(proveedor => {
                const row = document.createElement('tr');
                row.id = `row-${proveedor.id}`;
                row.innerHTML = `
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarp('${proveedor.id}')">✏️</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarp('${proveedor.id}')">❌</button>
                    </td>
                    <td>${proveedor.nombre}</td>
                    <td>${proveedor.telefono}</td>
                    <td>${proveedor.correo}</td>
                    <td>${proveedor.direccion}</td>
                    <td>${proveedor.productosProveedor}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error al actualizar la tabla:', error);
        }
    };
    

    



    



    



    




    function editarp(id) {
        fetch(`/proveedores/${id}`)
            .then(response => response.json())
            .then(data => {
                // Verificar si hay un error (Proveedor no encontrado)
                if (data.error) {
                    alert("Error: No se encontró el proveedor.");
                    return;
                }

                // Acceder al proveedor desde la respuesta
                const proveedor = data;

                // Rellenar los campos del modal con los valores existentes
                // document.getElementById("pId").value = proveedor.id;  // ID del proveedor
                document.getElementById("empresa").value = proveedor.empresa;  // Empresa
                document.getElementById("telefono").value = proveedor.telefono;  // Teléfono
                document.getElementById("correo").value = proveedor.correo;  // Correo
                document.getElementById("direccion").value = proveedor.direccion;  // Dirección
                document.getElementById("productos").value = proveedor.productos;  // Productos

                // Abrir el modal
                new bootstrap.Modal(document.getElementById("modalp")).show();
            })
            .catch(error => console.error("Error al obtener proveedor:", error));
    }

    function eliminarp(id) {
        fetch(`/proveedores/eliminar/${id}`, { method: "DELETE" })
            .then(() => location.reload());
    }

    function filtrarpes() {
        const filtro = document.getElementById("buscar").value.toLowerCase();
        document.querySelectorAll("#tablapes tr").forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(filtro) ? "" : "none";
        });
    }
</script>

{% endblock %}