{% extends "shared/base_admin.html" %}

{% block title %}Gestión de Proveedores{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="text-white mb-3 fw-normal fs-6" style="padding-left: 250px;">
        Home / Administrador / Gestionar Proveedores
    </div>
    <main class="col-md-9 ms-sm-auto col-lg-10 px-4 rounded-4">
        <div class="container mt-3">
            <!-- Botón y búsqueda -->
            <div class="d-flex justify-content-between mb-3">
                <!--  ^ Boton para habrir el modal -->
                <button 
                    class="btn btn-success" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalp"
                    onclick="limpiarFormulario()">
                    ➕ Nuevo proveedor
                </button>
                <input type="text" id="buscar" placeholder="Buscar" class="form-control" style="max-width: 200px;"
                    onkeyup="filtrarpes()">
            </div>

            <div class="table-responsive">
                <!-- Tabla de proveedores -->
                <table class="table table-bordered bg-white text-center">
                    <thead>
                        <tr>
                            <th>Acción</th>
                            <th>Empresa</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Dirección</th>
                            <th>Productos</th>
                        </tr>
                    </thead> 
                    <tbody id="tablapes">
                        {% for p in proveedor %}
                        <tr id="row-{{ p.idProveedores }}">
                            <td>
                                <!-- ? Boton para modificar el elemento selecciónado -->
                                <button 
                                    class="btn btn-warning btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalp"
                                    onclick="editarp('{{ p.idProveedores }}')">✏️
                                </button>
                                <button 
                                    class="btn btn-danger btn-sm" 
                                    onclick="eliminarp('{{ p.idProveedores }}')">❌
                                </button>
                            </td>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.telefono }}</td>
                            <td>{{ p.correo }}</td>
                            <td>{{ p.direccion }}</td>
                            <td>{{ p.productosProveedor }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
        </div>

        <!-- ^ Modal para agregar/editar proveedores -->
        <div class="modal fade" id="modalp" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar un proveedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <form method="post" action="{{ url_for('admin.proveedores') }}" id="formp">
                            <!-- ? Campo oculto para el ID del proveedor -->
                            <input type="hiden" id="idProveedor" name="idProveedor">

                            {{ form.hidden_tag() }}
                            <!-- <input type="hidden" name="pId"> -->
                            <div class="mb-3">
                                {{ form.empresa.label(class="form-label") }}
                                {{ form.empresa(class="form-control", id="empresa", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.telefono.label(class="form-label") }}
                                {{ form.telefono(class="form-control", id="telefono", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.correo.label(class="form-label") }}
                                {{ form.correo(class="form-control", id="correo", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.direccion.label(class="form-label") }}
                                {{ form.direccion(class="form-control", id="direccion", required="required") }}
                            </div>
                            <div class="mb-3">
                                {{ form.productos.label(class="form-label") }}
                                {{ form.productos(class="form-control", id="productos", required="required") }}
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <!-- <button class="btn btn-primary" onclick="guardarp()">Guardar</button> -->
                        <button class="btn btn-primary" onclick="guardarp()" id="btnGuardar">Guardar</button>
                    </div>

                    

                </div>
            </div>
        </div>




    </main>
</div>

<!-- JavaScript -->
<script>

    // <!-- ? Insertar los datos dentro de la BD           (C)   -->
    async function guardarp() {
        try {

            // <!-- * COnstantes para el ID del proveedor -->
            const idProveedor = document.getElementById('idProveedor').value;
            const esEdicion = idProveedor !=='';1



            // <!-- * Constante para almacenar los datos del formulario del modal -->
            const data = {
                empresa: document.getElementById('empresa').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                correo: document.getElementById('correo').value.trim(),
                direccion: document.getElementById('direccion').value.trim(),
                productos: document.getElementById('productos').value.trim()
            };

            // Validamos que los campos esten completos
            if (!data.empresa || !data.telefono || !data.correo) {
                throw new Error('Por favor completa TODOS los campos requeridos');
            }

            // <!-- ? Para la ruta para agregar/modificar proveedores usamos un ternario-->
            const url = esEdicion
                ? `/proveedores/editar/?{idProveedor}`
                : '/admin/proveedores/agregar';

            // 
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name="csrf_token"]')?.value || ''
                },
                body: JSON.stringify(data)
            });

            // Verificamos si la respuesta es exitosa
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
            }


            // <!-- ?  -->
            const result = await response.json();



            // <!-- ~ Acciones finales de la función -->
            // <!-- * Mostramos un mensaje de éxito con la aletra -->
            // <!-- TODO Agregar algo como swet alert  -->
            mostrarNotificacion(result.mensaje, 'success');

            // <!-- * Cerramos el modal y limpiamos el formulario -->
            cerrarModal();
            limpiarFormulario();
            actualizarTablaProveedores();
        } catch (error) {
            console.error('Error:', error);
            mostrarNotificacion(error.message || 'Error desconocido', 'error');
        }
    }

    // <!-- ? Editar los datos dentro de la BD           (U)  -->
    async function editarp(id) {
        try {
            // <!-- * Hacemos  -->
            const response = await fetch('/admin/proveedores/obtener/${id}');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
            }

            // <!--  -->
            const proveedor = await response.json();

            // <!-- * Rellenamos el formulario del modal con los datos del proveedor selecionado -->
            document.getElementById("idProveedor").value = proveedor.idProveedor;  // Id
            document.getElementById("empresa").value = proveedor.empresa;  // Empresa
            document.getElementById("telefono").value = proveedor.telefono;  // Teléfono
            document.getElementById("correo").value = proveedor.correo;  // Correo
            document.getElementById("direccion").value = proveedor.direccion;  // Dirección
            document.getElementById("productos").value = proveedor.productosProveedor;  // Productos

            
            // <!-- * Cambiar el título dle modal -->
            document.querySelector('.modal-title').textContent = 'Editar proveedor'



            // <!-- * Mostramos el modal -->
            new bootstrap.Modal(document.getElementById('modalp')).show();
        }catch (error){
            console.error('Error al obtener el porveedor:', error);
            mostrarNotificacion('Error al cargar los datos del proveedor', 'error');
        }
    }








    // <!-- ? Eliminar los datos dentro de la BD           (D)  -->
    function eliminarp(id) {
        fetch(`/proveedores/eliminar/${id}`, { method: "DELETE" })
            .then(() => location.reload());
    }




    // <!-- ? Función para Filtrar los datos dentro de la BD           (Otro)  -->
    function filtrarpes() {
        const filtro = document.getElementById("buscar").value.toLowerCase();
        document.querySelectorAll("#tablapes tr").forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(filtro) ? "" : "none";
        });
    }




    // <!-- ^ Funciónes generales -->

    // <!-- ? Mostramos las notificaciónes: -->
    function mostrarNotificacion(mensaje, tipo='success'){
        // <!-- TODO es para implementarlo con 'SweetAlert' u otros -->
        alert(`${tipo.toUpperCase()}: ${mensaje}`);
    };

    // <!-- ? Actualizamos la tabla sin necesidad de recargar la página -->
    async function actualizarTablaProveedores() {
        try {
            
            const response = await fetch('/admin/proveedores/listar');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
            }

            const proveedores = await response.json();

            // Actualizar la tabla con los datos obtenidos
            const tbody = document.querySelector('#tablapes');
            tbody.innerHTML = ''; // Limpiar la tabla

            proveedores.forEach(proveedor => {
                const row = document.createElement('tr');
                row.id = `row-${proveedor.id}`;
                row.innerHTML = `
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarp('${proveedor.id}')">✏️</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarp('${proveedor.id}')">❌</button>
                    </td>
                    <td>${proveedor.nombre}</td>
                    <td>${proveedor.telefono}</td>
                    <td>${proveedor.correo}</td>
                    <td>${proveedor.direccion}</td>
                    <td>${proveedor.productosProveedor}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error al actualizar la tabla:', error);
        }
    };
    
    // <!-- ? Limpiamos los campos del formulario del modal -->
    function limpiarFormulario() {
        document.getElementById("formp").reset();
        // const pIdElement = document.getElementById("pId");
        /*
        if (pIdElement) {
            pIdElement.value = "";
        }
        */
    }

    // <!-- ? Cerrar el modal correctamente -->
    function cerrarModal() {
        const modalElement = document.getElementById('modalp');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide(); // Cierra el modal
        }

        // Mueve el foco al botón que activó el modal
        const abrirModalButton = document.querySelector('button[data-bs-target="#modalp"]');
        if (abrirModalButton) {
            abrirModalButton.focus();
        }
    }

    


</script>

{% endblock %}